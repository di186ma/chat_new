(()=>{"use strict";var e={652:(e,o,a)=>{var t=a(751),r=a(641),s=a(33);const n={class:"app"},l={class:"user-info"},c={class:"username"};function u(e,o,a,t,u,i){const d=(0,r.g2)("Menubar"),m=(0,r.g2)("router-view");return(0,r.uX)(),(0,r.CE)("div",n,[(0,r.bF)(d,{model:t.menuItems},(0,r.eX)({_:2},[t.isAuthenticated?{name:"end",fn:(0,r.k6)((()=>[(0,r.Lk)("div",l,[(0,r.Lk)("span",c,(0,s.v_)(t.username),1)])])),key:"0"}:void 0]),1032,["model"]),(0,r.bF)(m)])}var i=a(123),d=a(278),m=a(220);const p={name:"App",components:{Menubar:i.A},setup(){const e=(0,d.Pj)(),o=(0,m.rd)(),a=(0,r.EW)((()=>e.getters.isAuthenticated)),t=(0,r.EW)((()=>{const o=e.state.user;return o?o.username:""})),s=(0,r.EW)((()=>a.value?[{label:"Комнаты",icon:"pi pi-home",command:()=>o.push("/rooms")},{label:"Выйти",icon:"pi pi-sign-out",command:()=>{e.dispatch("logout"),o.push("/login")}}]:[{label:"Войти",icon:"pi pi-sign-in",command:()=>o.push("/login")},{label:"Регистрация",icon:"pi pi-user-plus",command:()=>o.push("/register")}]));return{menuItems:s,isAuthenticated:a,username:t}}};var g=a(262);const h=(0,g.A)(p,[["render",u]]),b=h,v={class:"login-container"},k={class:"p-field"},f={class:"p-field"};function w(e,o,a,n,l,c){const u=(0,r.g2)("InputText"),i=(0,r.g2)("Password"),d=(0,r.g2)("Message"),m=(0,r.g2)("Button"),p=(0,r.g2)("Card");return(0,r.uX)(),(0,r.CE)("div",v,[(0,r.bF)(p,{class:"login-card"},{title:(0,r.k6)((()=>o[3]||(o[3]=[(0,r.eW)("Вход")]))),content:(0,r.k6)((()=>[(0,r.Lk)("form",{onSubmit:o[2]||(o[2]=(0,t.D$)(((...e)=>n.handleSubmit&&n.handleSubmit(...e)),["prevent"]))},[(0,r.Lk)("div",k,[o[4]||(o[4]=(0,r.Lk)("label",{for:"username"},"Имя пользователя",-1)),(0,r.bF)(u,{id:"username",modelValue:n.username,"onUpdate:modelValue":o[0]||(o[0]=e=>n.username=e)},null,8,["modelValue"])]),(0,r.Lk)("div",f,[o[5]||(o[5]=(0,r.Lk)("label",{for:"password"},"Пароль",-1)),(0,r.bF)(i,{id:"password",modelValue:n.password,"onUpdate:modelValue":o[1]||(o[1]=e=>n.password=e)},null,8,["modelValue"])]),n.error?((0,r.uX)(),(0,r.Wv)(d,{key:0,severity:"error"},{default:(0,r.k6)((()=>[(0,r.eW)((0,s.v_)(n.error),1)])),_:1})):(0,r.Q3)("",!0),(0,r.bF)(m,{type:"submit",label:"Войти"})],32)])),_:1})])}var y=a(953),A=a(81),S=a(842),C=a(225),R=a(512),_=a(897);const E={components:{Card:A.A,InputText:S.A,Password:C.A,Button:R.A,Message:_.A},setup(){const e=(0,d.Pj)(),o=(0,m.rd)(),a=(0,y.KR)(""),t=(0,y.KR)(""),s=(0,r.EW)((()=>e.getters.error)),n=async()=>{try{const r=await e.dispatch("login",{username:a.value,password:t.value});console.log("Login response:",r),o.push("/rooms")}catch(s){console.error("Login failed:",s)}};return{username:a,password:t,error:s,handleSubmit:n}}},I=(0,g.A)(E,[["render",w],["__scopeId","data-v-4a51e6d1"]]),L=I,F={class:"register-container"},T={class:"p-field"},V={class:"p-field"},W={class:"p-field"};function O(e,o,a,n,l,c){const u=(0,r.g2)("InputText"),i=(0,r.g2)("Password"),d=(0,r.g2)("Message"),m=(0,r.g2)("Button"),p=(0,r.g2)("Card");return(0,r.uX)(),(0,r.CE)("div",F,[(0,r.bF)(p,{class:"register-card"},{title:(0,r.k6)((()=>o[4]||(o[4]=[(0,r.eW)("Регистрация")]))),content:(0,r.k6)((()=>[(0,r.Lk)("form",{onSubmit:o[3]||(o[3]=(0,t.D$)(((...e)=>n.handleSubmit&&n.handleSubmit(...e)),["prevent"]))},[(0,r.Lk)("div",T,[o[5]||(o[5]=(0,r.Lk)("label",{for:"username"},"Имя пользователя",-1)),(0,r.bF)(u,{id:"username",modelValue:n.username,"onUpdate:modelValue":o[0]||(o[0]=e=>n.username=e)},null,8,["modelValue"])]),(0,r.Lk)("div",V,[o[6]||(o[6]=(0,r.Lk)("label",{for:"password"},"Пароль",-1)),(0,r.bF)(i,{id:"password",modelValue:n.password,"onUpdate:modelValue":o[1]||(o[1]=e=>n.password=e)},null,8,["modelValue"])]),(0,r.Lk)("div",W,[o[7]||(o[7]=(0,r.Lk)("label",{for:"password2"},"Подтверждение пароля",-1)),(0,r.bF)(i,{id:"password2",modelValue:n.password2,"onUpdate:modelValue":o[2]||(o[2]=e=>n.password2=e)},null,8,["modelValue"])]),n.error?((0,r.uX)(),(0,r.Wv)(d,{key:0,severity:"error"},{default:(0,r.k6)((()=>[(0,r.eW)((0,s.v_)(n.error),1)])),_:1})):(0,r.Q3)("",!0),(0,r.bF)(m,{type:"submit",label:"Зарегистрироваться"})],32)])),_:1})])}const P={components:{Card:A.A,InputText:S.A,Password:C.A,Button:R.A,Message:_.A},setup(){const e=(0,d.Pj)(),o=(0,m.rd)(),a=(0,y.KR)(""),t=(0,y.KR)(""),s=(0,y.KR)(""),n=(0,r.EW)((()=>e.getters.error)),l=async()=>{try{await e.dispatch("register",{username:a.value,password:t.value,password2:s.value}),o.push("/login")}catch(n){console.error("Registration failed:",n)}};return{username:a,password:t,password2:s,error:n,handleSubmit:l}}},D=(0,g.A)(P,[["render",O],["__scopeId","data-v-c6ecc1b2"]]),$=D,j={class:"chat-container"},K={class:"messages-container",ref:"messagesContainer"},U={class:"input-container"};function B(e,o,a,n,l,c){const u=(0,r.g2)("InputText"),i=(0,r.g2)("Button"),d=(0,r.g2)("Card");return(0,r.uX)(),(0,r.CE)("div",j,[(0,r.bF)(d,null,{title:(0,r.k6)((()=>[(0,r.eW)("Чат: "+(0,s.v_)(a.roomName),1)])),content:(0,r.k6)((()=>[(0,r.Lk)("div",K,[((0,r.uX)(!0),(0,r.CE)(r.FK,null,(0,r.pI)(n.messages,((e,o)=>((0,r.uX)(),(0,r.CE)("div",{key:o,class:(0,s.C4)(["message",{"my-message":e.username===n.currentUsername}])},[(0,r.Lk)("strong",null,(0,s.v_)(e.username)+":",1),(0,r.eW)(" "+(0,s.v_)(e.message||e.content),1)],2)))),128))],512),(0,r.Lk)("div",U,[(0,r.bF)(u,{modelValue:n.newMessage,"onUpdate:modelValue":o[0]||(o[0]=e=>n.newMessage=e),onKeyup:(0,t.jR)(n.sendMessage,["enter"]),placeholder:"Введите сообщение..."},null,8,["modelValue","onKeyup"]),(0,r.bF)(i,{icon:"pi pi-send",onClick:n.sendMessage},null,8,["onClick"])])])),_:1})])}var M=a(335);const N={name:"Chat",components:{Card:A.A,InputText:S.A,Button:R.A},props:{roomName:{type:String,required:!0}},setup(e){const o=(0,d.Pj)(),a=(0,y.KR)([]),t=(0,y.KR)(""),s=(0,y.KR)(null);let n=null;const l=(0,r.EW)((()=>o.state.user?o.state.user.username:"")),c=async()=>{await(0,r.dY)(),s.value&&(s.value.scrollTop=s.value.scrollHeight)},u=async()=>{try{const o=await M.A.get("/api/rooms/",{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}}),t=o.data.find((o=>o.name===e.roomName));if(t){const e=await M.A.get(`/api/messages/?room=${t.id}`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});console.log("Loaded messages:",e.data),a.value=e.data.map((e=>({username:e.username||(e.user?e.user.username:"Unknown"),message:e.content}))),await c()}}catch(o){console.error("Error loading messages:",o)}},i=()=>{const o=localStorage.getItem("token"),t="https:"===window.location.protocol?"wss:":"ws:",r=`${t}//${window.location.host}/ws/chat/${e.roomName}/?token=${o}`;console.log("Connecting to WebSocket:",r),n=new WebSocket(r),n.onopen=()=>{console.log("WebSocket connection established")},n.onmessage=e=>{const o=JSON.parse(e.data);a.value.push(o),c()},n.onclose=e=>{console.log("WebSocket connection closed",e.code,e.reason),setTimeout(i,1e3)},n.onerror=e=>{console.error("WebSocket error:",e)}},m=()=>{t.value.trim()&&n&&n.readyState===WebSocket.OPEN&&(n.send(JSON.stringify({message:t.value})),t.value="")};return(0,r.sV)((()=>{u(),i()})),(0,r.hi)((()=>{n&&n.close()})),{messages:a,newMessage:t,messagesContainer:s,currentUsername:l,sendMessage:m}}},x=(0,g.A)(N,[["render",B],["__scopeId","data-v-c2b46392"]]),X=x,z={class:"room-list"},q={class:"header"},J={class:"buttons"},Q={class:"room-list-content"},H={class:"create-room-form"};function Y(e,o,a,t,n,l){const c=(0,r.g2)("Button"),u=(0,r.g2)("router-link"),i=(0,r.g2)("InputText"),d=(0,r.g2)("Dialog");return(0,r.uX)(),(0,r.CE)("div",z,[(0,r.Lk)("div",q,[o[4]||(o[4]=(0,r.Lk)("h2",null,"Комнаты чата",-1)),(0,r.Lk)("div",J,[(0,r.bF)(c,{label:"Создать комнату",onClick:o[0]||(o[0]=e=>t.showCreateRoomDialog=!0)}),(0,r.bF)(c,{label:"Просмотр данных",onClick:t.goToDataTable,class:"p-button-secondary"},null,8,["onClick"])])]),(0,r.Lk)("div",Q,[((0,r.uX)(!0),(0,r.CE)(r.FK,null,(0,r.pI)(t.rooms,(e=>((0,r.uX)(),(0,r.CE)("div",{key:e.id,class:"room-item"},[(0,r.bF)(u,{to:{name:"chat",params:{roomName:e.name}}},{default:(0,r.k6)((()=>[(0,r.eW)((0,s.v_)(e.name),1)])),_:2},1032,["to"])])))),128))]),(0,r.bF)(d,{visible:t.showCreateRoomDialog,"onUpdate:visible":o[3]||(o[3]=e=>t.showCreateRoomDialog=e),header:"Создание комнаты",modal:!0},{footer:(0,r.k6)((()=>[(0,r.bF)(c,{label:"Отмена",onClick:o[2]||(o[2]=e=>t.showCreateRoomDialog=!1),class:"p-button-text"}),(0,r.bF)(c,{label:"Создать",onClick:t.createRoom},null,8,["onClick"])])),default:(0,r.k6)((()=>[(0,r.Lk)("div",H,[(0,r.bF)(i,{modelValue:t.newRoomName,"onUpdate:modelValue":o[1]||(o[1]=e=>t.newRoomName=e),placeholder:"Название комнаты"},null,8,["modelValue"])])])),_:1},8,["visible"])])}var G=a(637);const Z={name:"RoomList",components:{Button:R.A,Dialog:G.A,InputText:S.A},setup(){const e=(0,d.Pj)(),o=(0,m.rd)(),a=(0,y.KR)(""),t=(0,y.KR)(!1),s=(0,r.EW)((()=>e.getters.rooms)),n=async()=>{try{await e.dispatch("loadRooms")}catch(o){console.error("Ошибка при загрузке комнат:",o)}},l=async()=>{if(a.value.trim())try{await e.dispatch("createRoom",a.value),a.value="",t.value=!1,await n()}catch(o){console.error("Ошибка при создании комнаты:",o)}},c=()=>{o.push("/data")};return(0,r.sV)(n),{rooms:s,newRoomName:a,showCreateRoomDialog:t,createRoom:l,goToDataTable:c}}},ee=(0,g.A)(Z,[["render",Y],["__scopeId","data-v-3d7593d3"]]),oe=ee,ae={class:"data-table-page"};function te(e,o,a,t,n,l){const c=(0,r.g2)("Column"),u=(0,r.g2)("DataTable");return(0,r.uX)(),(0,r.CE)("div",ae,[o[0]||(o[0]=(0,r.Lk)("h2",null,"Данные из базы данных",-1)),(0,r.bF)(u,{value:t.messages,paginator:!0,rows:10,rowsPerPageOptions:[5,10,20],loading:t.loading,responsiveLayout:"scroll"},{default:(0,r.k6)((()=>[(0,r.bF)(c,{field:"id",header:"ID",sortable:!0}),(0,r.bF)(c,{field:"username",header:"Пользователь",sortable:!0}),(0,r.bF)(c,{field:"content",header:"Сообщение",sortable:!0}),(0,r.bF)(c,{field:"room",header:"Комната",sortable:!0}),(0,r.bF)(c,{field:"created_at",header:"Дата",sortable:!0},{body:(0,r.k6)((e=>[(0,r.eW)((0,s.v_)(t.formatDate(e.data.created_at)),1)])),_:1})])),_:1},8,["value","loading"])])}var re=a(535),se=a(835);const ne={name:"DataTablePage",components:{DataTable:re.A,Column:se.A},setup(){const e=(0,d.Pj)(),o=(0,y.KR)([]),a=(0,y.KR)(!0),t=async()=>{try{const a=await M.A.get("http://localhost:8000/api/messages/",{headers:{Authorization:`Bearer ${e.state.token}`}});o.value=a.data}catch(t){console.error("Ошибка при загрузке сообщений:",t)}finally{a.value=!1}},s=e=>{const o=new Date(e);return o.toLocaleString("ru-RU")};return(0,r.sV)((()=>{t()})),{messages:o,loading:a,formatDate:s}}},le=(0,g.A)(ne,[["render",te],["__scopeId","data-v-c01c1c7c"]]),ce=le,ue=[{path:"/",name:"home",component:oe},{path:"/login",name:"login",component:L},{path:"/register",name:"register",component:$},{path:"/rooms",name:"RoomList",component:oe,meta:{requiresAuth:!0}},{path:"/chat/:roomName",name:"chat",component:X,props:!0,meta:{requiresAuth:!0}},{path:"/",redirect:"/rooms"},{path:"/data",name:"data",component:ce}],ie=(0,m.aE)({history:(0,m.LA)(),routes:ue});ie.beforeEach(((e,o,a)=>{const t=(0,d.Pj)(),r=t.state.token;e.matched.some((e=>e.meta.requiresAuth))?r?a():a("/login"):a()}));const de=ie,me="/api",pe=(0,d.y$)({state:{token:localStorage.getItem("token")||null,user:(()=>{try{const e=localStorage.getItem("user");return e?JSON.parse(e):null}catch(e){return console.error("Ошибка при парсинге данных пользователя:",e),localStorage.removeItem("user"),null}})(),rooms:[],error:null},getters:{isAuthenticated:e=>!!e.token,error:e=>e.error,user:e=>e.user,rooms:e=>e.rooms},mutations:{setToken(e,o){e.token=o,localStorage.setItem("token",o)},clearToken(e){e.token=null,localStorage.removeItem("token")},setUser(e,o){e.user=o,localStorage.setItem("user",JSON.stringify(o))},clearUser(e){e.user=null,localStorage.removeItem("user")},setError(e,o){e.error=o},clearError(e){e.error=null},setRooms(e,o){e.rooms=o},clearAuth(e){e.token=null,e.user=null,localStorage.removeItem("token"),localStorage.removeItem("user")}},actions:{async login({commit:e},o){try{e("clearError");const a=await M.A.post(`${me}/token/`,o),{access:t,refresh:r,user:s}=a.data;return e("setToken",t),e("setUser",s),M.A.defaults.headers.common["Authorization"]=`Bearer ${t}`,console.log("Logged in user:",s),a.data}catch(a){throw e("setError",a.response?.data?.error||"Ошибка входа"),a}},async register({commit:e},o){try{e("clearError");const a=await M.A.post(`${me}/register/`,o);return a.data}catch(a){throw e("setError",a.response?.data?.error||"Ошибка регистрации"),a}},logout({commit:e}){e("clearAuth"),delete M.A.defaults.headers.common["Authorization"]},async loadRooms({commit:e}){try{e("clearError");const o=await M.A.get(`${me}/rooms/`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});return e("setRooms",o.data),o}catch(o){throw e("setError",o.response?.data?.error||"Ошибка загрузки комнат"),o}},async createRoom({commit:e,dispatch:o},a){try{e("clearError");const t=await M.A.post(`${me}/rooms/`,{name:a},{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});return await o("loadRooms"),t.data}catch(t){throw e("setError",t.response?.data?.error||"Ошибка создания комнаты"),t}}}});var ge=a(656);const he=(0,t.Ef)(b);he.use(pe),he.use(de),he.use(ge.Ay),he.mount("#app")}},o={};function a(t){var r=o[t];if(void 0!==r)return r.exports;var s=o[t]={exports:{}};return e[t](s,s.exports,a),s.exports}a.m=e,(()=>{var e=[];a.O=(o,t,r,s)=>{if(!t){var n=1/0;for(i=0;i<e.length;i++){for(var[t,r,s]=e[i],l=!0,c=0;c<t.length;c++)(!1&s||n>=s)&&Object.keys(a.O).every((e=>a.O[e](t[c])))?t.splice(c--,1):(l=!1,s<n&&(n=s));if(l){e.splice(i--,1);var u=r();void 0!==u&&(o=u)}}return o}s=s||0;for(var i=e.length;i>0&&e[i-1][2]>s;i--)e[i]=e[i-1];e[i]=[t,r,s]}})(),(()=>{a.d=(e,o)=>{for(var t in o)a.o(o,t)&&!a.o(e,t)&&Object.defineProperty(e,t,{enumerable:!0,get:o[t]})}})(),(()=>{a.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()})(),(()=>{a.o=(e,o)=>Object.prototype.hasOwnProperty.call(e,o)})(),(()=>{a.r=e=>{"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}})(),(()=>{var e={524:0};a.O.j=o=>0===e[o];var o=(o,t)=>{var r,s,[n,l,c]=t,u=0;if(n.some((o=>0!==e[o]))){for(r in l)a.o(l,r)&&(a.m[r]=l[r]);if(c)var i=c(a)}for(o&&o(t);u<n.length;u++)s=n[u],a.o(e,s)&&e[s]&&e[s][0](),e[s]=0;return a.O(i)},t=self["webpackChunkchat_app"]=self["webpackChunkchat_app"]||[];t.forEach(o.bind(null,0)),t.push=o.bind(null,t.push.bind(t))})();var t=a.O(void 0,[504],(()=>a(652)));t=a.O(t)})();
//# sourceMappingURL=app.6b66f26c.js.map